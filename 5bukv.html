<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>

.word {
  font-family: monospace, monospace;
  font-size: min(10vw, 20mm);
  letter-spacing: 1em;
  text-transform: uppercase;
}

.word1 {
  background-color: lightgrey;
  color: darkgrey;
}

.word2 {
  background-color: white;
}

.word3 {
  background-color: yellow;
}

.game {
  display: block;
  width: min(8.2em, 200mm);
}

</style>
</head>
<body>

<div>
<span id="menu_new_game">New</span>
</div>
<div  id="menu_new_game_panel">
<div>
<label>Word</label><input id="new_game_word" type="text"/>
</div>
<div>
<label>Attempts</label><input id="new_game_attempts" type="number" min=1 value="6"/>
</div>
<div>
<button id="new_game_share"></button>
</div>
</div>


<div id="board" class="word"></div>

<div>
  <input id="word_input" type="text" minlength=5 maxlength=5 size=5 class="game word"/>
</div>
<div>

  <input id="word_button" type="button" class="word" value=">"/>
</div>

<script>

// Pack game object into an obfuscated string.
function pack_game(g) {
  const s = JSON.stringify(g);
  const b = new TextEncoder().encode(s);
  const bs = Array.from(b, (c) => String.fromCodePoint(c)).join("");
  return btoa(bs);
}

// Unpack obfuscated string into a game object.
function unpack_game(s) {
  const bs = atob(s);
  const b = Uint8Array.from(bs, (c) => c.codePointAt(0));
  return JSON.parse(new TextDecoder().decode(b));
}








function get_game() {
  let u = new URL(location.href);
  let v = u.searchParams.get("game")
  if (v) {
    let g =unpack_game(v);
    if (g.w) {
      console.log(g.w);
      return g.w.toUpperCase();
    }
  }
  console.log("ОМУЛЬ");
  return "ОМУЛЬ";
}

const secret_word = get_game();

function letter_class(i, c) {
  if (secret_word[i] == c) {
    return "word3";
  }
  if (secret_word.indexOf(c) != -1) {
    return "word2";
  }
  return "word1";
}

let words = [];

const board = document.getElementById("board");
const word_input = document.getElementById("word_input");
const word_button = document.getElementById("word_button");

function update_board() {
  let s = "";
  for (let w of words) {
    s += "<div>";
    for (let i = 0; i < w.length; ++i) {
      let c = w[i];
      let r = letter_class(i, c);
      console.log(i, c, r);
      s += "<span class='" + r + "'>";
      s += c;
      s += "</span>";
    }
    s += "</div>"
  }
  board.innerHTML = s;
  word_input.value = "";
}

function check_word(w) {
  let r = "https://ru.wiktionary.org/w/api.php?origin=*&action=query&format=json&titles=" + encodeURIComponent(w.toLowerCase());
  fetch(r, {mode:  'cors', method: 'GET'})
  .then((response) => response.json())
  .then((data) => {
    if (data.query && data.query.pages) {
      let k = Object.keys(data.query.pages)[0]
      if (k != -1) {
        words.push(w.toUpperCase());
        update_board();
        return;
        }
    }
    console.log("failed to find word", w);
  })
  .catch(console.error);
}

word_button.onclick = function () {
  let s = word_input.value;
  if (s.length != secret_word.length) {
    return;
  }
  check_word(s);
}

// word_input.placeholder = ".".repeat(secret_word.length);
word_input.placeholder = "СЛОВО";


//
// New game creator
//

const my_new_game_word = document.getElementById("new_game_word");
const my_new_game_attempts = document.getElementById("new_game_attempts");
const my_new_game_share = document.getElementById("new_game_share");

function calc_new_game() {
  let w = my_new_game_word.value;
  if (!w) {
    return null;
  }
  let n = my_new_game_attempts.value;
  if (!n || n <= 0) {
    return null;
  }
  return {w: w, n: n};
}

function update_new_game() {
  let g = calc_new_game();
  if (!g) {
    my_new_game_share.disabled = true;
  } else {
    my_new_game_share.disabled = false;
  }
}

function share_new_game() {
  const g = calc_new_game();
  if (!g) {
    return
  }
  let u = new URL(location);
  u.searchParams.set("game", pack_game(g));
  if (navigator.share) {
    navigator.share({
      title: '5bukv',
      url: u,
    })
    .then(() => {
    })
    .catch((e) => {
      console.log(e);
    });
  } else {
    navigator.clipboard.writeText(u.href)
    .then(() => {
    })
    .catch((e) => {
      console.log(e);
    });
  }
}

my_new_game_word.addEventListener("input", update_new_game);
my_new_game_attempts.addEventListener("input", update_new_game);
my_new_game_share.addEventListener("click", share_new_game);

const my_menu_new_game = document.getElementById("menu_new_game");
const my_menu_new_game_panel = document.getElementById("menu_new_game_panel");

my_menu_new_game_panel.style.display = "none";
if (navigator.share) {
  my_new_game_share.innerText = "Share link";
} else {
  my_new_game_share.innerText = "Copy link";
}
my_new_game_share.disabled = true;

my_menu_new_game.addEventListener("click", () => {
  if (my_menu_new_game_panel.style.display != "none") {
    my_menu_new_game_panel.style.display = "none";
  } else {
    my_menu_new_game_panel.style.display = "block";
  }
});

</script>
</body>
</html>
